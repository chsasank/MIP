clc; clear;close all
S = [0.5045 - 1i*0.0217, 0.6874 + 1i*0.0171, 0.3632 + 1i*0.1789, 0.3483 + 1i*0.1385, 0.2606 - 1i*0.0675, 0.2407 + 1i*0.1517];
S = abs(S);
G = [[1;0],[0.866;0.5],[0.5;0.866],[0;1],[-0.5;0.866],[-0.866;0.5]];
rng(0);

%% Gradient descent on L
x =  rand(1,3);
cost_history = [];
D_history = [];
x
diff = 2;
a = 1;
while diff > 1e-15
    [f,grad] = costFunction(x,S,G);
    cost_history = [cost_history f];
    
    x_new = x - a*grad;
    if x_new(1) < 0
        x_new(1) = 0;
    end
    if x_new(2) < 0
       x_new(2) = 0;
    end
    
    L = [x(1) 0; x(3) x(2)];
    D = L*L';
    D_history = [D_history D(:)];


    
    
    f_new = costFunction(x_new,S,G);
    if f_new > f
        a = a/2;
    else
        a = a*1.1;
    end
    
    diff = abs(x - x_new)/abs(x);
    
    x = x_new;
end

figure
plot(log(cost_history)) 
title('cost over iterations')

figure
plot(D(1,:)) 
title('D(1,1) over iterations')


figure
plot(D(2,:)) 
title('D(1,2) over iterations')

figure
plot(D_hi(3,:)) 
title('D(2,1) over iterations')

figure
plot(D(4,:)) 
title('D(2,2) over iterations')

[f,grad] = costFunction(x,S,G)
if norm(grad) > 1e-3
    %from trail and error
    error('rerun. stuck at local minima')
end
L = [x(1) 0; x(3) x(2)]

%% results
D = L*L'
[U,S,V] = svd(D);
%%
% Principal Direction Vector
disp(U(:,1))

%%
% ratio of diffusion in the principal direction and diffusion in the direction orthogonal to it 
disp(S(1,1)/S(2,2))